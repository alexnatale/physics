let homework = null;
let studentId = '';
let rng = null;
let autosaveInterval = null;

function getCurrentHomework() {
    return '1'; // Hardcoded to 1 for now
}

function getCourseNumber() {
    return '217'; // Hardcoded to 217 for now
}

async function loadHomework() {
    studentId = document.getElementById('student-id').value.trim();
    if (!studentId) {
        alert('Please enter a Student ID');
        return;
    }

    rng = new Math.seedrandom(studentId);

    const homeworkNumber = getCurrentHomework();
    const courseNumber = getCourseNumber();

    try {
        const response = await fetch(`course${courseNumber}_hw${homeworkNumber}.json`);
        homework = await response.json();
        generateProblems();
        document.querySelector('#submission button').style.display = 'block';
        loadSavedProgress();
        startAutosave();
    } catch (error) {
        console.error('Error loading homework:', error);
        alert('Error loading homework. Please try again.');
    }
}

function generateProblems() {
    const problemsDiv = document.getElementById('homework-problems');
    problemsDiv.innerHTML = '';

    homework.problems.forEach((problem, index) => {
        const problemDiv = document.createElement('div');
        problemDiv.className = 'problem';
        
        let questionText = problem.question;
        problem.variables?.forEach(variable => {
            const value = variable.min + rng() * (variable.max - variable.min);
            questionText = questionText.replace(`{${variable.name}}`, value.toFixed(2));
        });

        problemDiv.innerHTML = `<p>${index + 1}. ${questionText}</p>`;

        if (problem.type === 'numerical') {
            problemDiv.innerHTML += `
                <div class="numerical-input">
                    <input type="text" id="answer-${index}-value" placeholder="Value (in scientific notation)">
                    <input type="text" id="answer-${index}-unit" placeholder="Unit">
                </div>
            `;
        } else if (problem.type === 'multiple-choice') {
            problem.choices.forEach((choice, choiceIndex) => {
                const letter = String.fromCharCode(97 + choiceIndex); // a, b, c, d, e, f
                problemDiv.innerHTML += `
                    <div>
                        <input type="radio" id="answer-${index}-${letter}" name="answer-${index}" value="${letter}">
                        <label for="answer-${index}-${letter}">${letter}) ${choice}</label>
                    </div>
                `;
            });
        }

        problemsDiv.appendChild(problemDiv);
    });

    document.querySelectorAll('input').forEach(input => {
        input.addEventListener('change', saveProgress);
    });
}

async function submitAnswers() {
    const answers = getAnswers();
    const data = {
        studentId: studentId,
        courseNumber: getCourseNumber(),
        homeworkNumber: getCurrentHomework(),
        answers: answers
    };

    try {
        const response = await fetch('https://your-backend-service-url/submit-answers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            alert('Your answers have been submitted!');
            console.log('Student Answers:', answers);
            localStorage.removeItem(`saved-progress-${studentId}-${getCourseNumber()}-${getCurrentHomework()}`);
        } else {
            alert('Error submitting your answers. Please try again later.');
        }
    } catch (error) {
        console.error('Error submitting answers:', error);
        alert('Error submitting your answers. Please try again later.');
    }
}


function saveProgress() {
    const answers = getAnswers();
    localStorage.setItem(`saved-progress-${studentId}-${getCourseNumber()}-${getCurrentHomework()}`, JSON.stringify(answers));
    console.log('Progress saved');
}

async function loadSavedProgress() {
    try {
        const response = await fetch(`https://your-backend-service-url/get-answers?studentId=${studentId}&courseNumber=${getCourseNumber()}&homeworkNumber=${getCurrentHomework()}`);
        if (response.ok) {
            const savedAnswers = await response.json();
            homework.problems.forEach((problem, index) => {
                if (problem.type === 'numerical') {
                    document.getElementById(`answer-${index}-value`).value = savedAnswers[index]?.value || '';
                    document.getElementById(`answer-${index}-unit`).value = savedAnswers[index]?.unit || '';
                } else if (problem.type === 'multiple-choice') {
                    const radio = document.getElementById(`answer-${index}-${savedAnswers[index]}`);
                    if (radio) radio.checked = true;
                }
            });
            console.log('Progress loaded');
        }
    } catch (error) {
        console.error('Error loading saved progress:', error);
    }
}


function startAutosave() {
    autosaveInterval = setInterval(saveProgress, 30000);
}

function stopAutosave() {
    clearInterval(autosaveInterval);
}

// Event Listeners
window.addEventListener('load', () => {
    const homeworkNumber = getCurrentHomework();
    const courseNumber = getCourseNumber();
    if (homeworkNumber && courseNumber) {
        document.getElementById('homework-title').textContent = `Homework ${homeworkNumber} - Physics ${courseNumber}`;
    }

    const studentIdInput = document.getElementById('student-id');
    const loadButton = document.querySelector('button');

    // Load homework when enter is pressed in the student ID input
    studentIdInput.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            loadHomework();
        }
    });

    // Load homework when the button is clicked
    loadButton.addEventListener('click', loadHomework);

    // Handle form submission
    document.querySelector('#submission button').addEventListener('click', function(event) {
        event.preventDefault();
        submitAnswers();
        stopAutosave();
    });
});

// Save progress when the user leaves the page
window.addEventListener('beforeunload', saveProgress);
