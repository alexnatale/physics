<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physics Homework System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/seedrandom/3.0.5/seedrandom.min.js"></script>
    <script>let homework = null;
let studentId = '';
let rng = null;
let autosaveInterval = null;

function getCurrentHomework() {
    return '1'; // Hardcoded to 1 for now
}

function getCourseNumber() {
    return '217'; // Hardcoded to 217 for now
}

async function loadHomework() {
    console.log('Load Homework button pressed');

    studentId = document.getElementById('student-id').value.trim();
    if (!studentId) {
        alert('Please enter a Student ID');
        return;
    }

    console.log('Student ID:', studentId);
    rng = new Math.seedrandom(studentId);

    const homeworkNumber = getCurrentHomework();
    const courseNumber = getCourseNumber();
    console.log(`Loading homework for course ${courseNumber}, homework ${homeworkNumber}`);

    try {
        const response = await fetch(`course${courseNumber}_hw${homeworkNumber}.json`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        homework = await response.json();
        console.log('Homework JSON:', homework);

        generateProblems();
        document.querySelector('#submission button').style.display = 'block';
        
        loadSavedProgress();
        startAutosave();
    } catch (error) {
        console.error('Error loading homework:', error);
        alert('Error loading homework. Please try again.');
    }
}

function generateProblems() {
    const problemsDiv = document.getElementById('homework-problems');
    problemsDiv.innerHTML = '';

    homework.problems.forEach((problem, index) => {
        const problemDiv = document.createElement('div');
        problemDiv.className = 'problem';
        
        let questionText = problem.question;
        problem.variables?.forEach(variable => {
            const value = variable.min + rng() * (variable.max - variable.min);
            questionText = questionText.replace(`{${variable.name}}`, value.toFixed(2));
        });

        problemDiv.innerHTML = `<p>${index + 1}. ${questionText}</p>`;

        if (problem.type === 'numerical') {
            problemDiv.innerHTML += `
                <div class="numerical-input">
                    <input type="text" id="answer-${index}-value" placeholder="Value (in scientific notation)">
                    <input type="text" id="answer-${index}-unit" placeholder="Unit">
                </div>
            `;
        } else if (problem.type === 'multiple-choice') {
            problem.choices.forEach((choice, choiceIndex) => {
                const letter = String.fromCharCode(97 + choiceIndex); // a, b, c, d, e, f
                problemDiv.innerHTML += `
                    <div>
                        <input type="radio" id="answer-${index}-${letter}" name="answer-${index}" value="${letter}">
                        <label for="answer-${index}-${letter}">${letter}) ${choice}</label>
                    </div>
                `;
            });
        }

        problemsDiv.appendChild(problemDiv);
    });

    document.querySelectorAll('input').forEach(input => {
        input.addEventListener('change', saveProgress);
    });
}

function loadSavedProgress() {
    const savedProgress = localStorage.getItem(`saved-progress-${studentId}-${getCourseNumber()}-${getCurrentHomework()}`);
    if (savedProgress) {
        const answers = JSON.parse(savedProgress);
        homework.problems.forEach((problem, index) => {
            if (problem.type === 'numerical') {
                document.getElementById(`answer-${index}-value`).value = answers[index]?.value || '';
                document.getElementById(`answer-${index}-unit`).value = answers[index]?.unit || '';
            } else if (problem.type === 'multiple-choice') {
                const radio = document.getElementById(`answer-${index}-${answers[index]}`);
                if (radio) radio.checked = true;
            }
        });
        console.log('Progress loaded');
    } else {
        console.log('No saved progress found, proceeding without loading.');
    }
}

function submitAnswers() {
    const answers = getAnswers();
    localStorage.setItem(`submitted-answers-${studentId}-${getCourseNumber()}-${getCurrentHomework()}`, JSON.stringify(answers));
    alert('Your answers have been submitted!');
    console.log('Student Answers:', answers);
    localStorage.removeItem(`saved-progress-${studentId}-${getCourseNumber()}-${getCurrentHomework()}`);
}

function getAnswers() {
    return homework.problems.map((problem, index) => {
        if (problem.type === 'numerical') {
            return {
                value: document.getElementById(`answer-${index}-value`).value,
                unit: document.getElementById(`answer-${index}-unit`).value
            };
        } else if (problem.type === 'multiple-choice') {
            const selected = document.querySelector(`input[name="answer-${index}"]:checked`);
            return selected ? selected.value : null;
        }
    });
}

function saveProgress() {
    const answers = getAnswers();
    localStorage.setItem(`saved-progress-${studentId}-${getCourseNumber()}-${getCurrentHomework()}`, JSON.stringify(answers));
    console.log('Progress saved');
}

function startAutosave() {
    autosaveInterval = setInterval(saveProgress, 30000);
}

function stopAutosave() {
    clearInterval(autosaveInterval);
}

// Event Listeners
window.addEventListener('load', () => {
    const homeworkNumber = getCurrentHomework();
    const courseNumber = getCourseNumber();
    if (homeworkNumber && courseNumber) {
        document.getElementById('homework-title').textContent = `Homework ${homeworkNumber} - Physics ${courseNumber}`;
    }

    const studentIdInput = document.getElementById('student-id');
    const loadButton = document.getElementById('load-homework-button');

    // Load homework when enter is pressed in the student ID input
    studentIdInput.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            loadHomework();
        }
    });

    // Load homework when the button is clicked
    loadButton.addEventListener('click', loadHomework);

    // Handle form submission
    document.getElementById('submit-answers-button').addEventListener('click', function(event) {
        event.preventDefault();
        submitAnswers();
        stopAutosave();
    });
});

// Save progress when the user leaves the page
window.addEventListener('beforeunload', saveProgress);</script>
    <style>
        .problem { margin-bottom: 20px; }
        .numerical-input { display: flex; align-items: center; }
        .numerical-input input { margin-right: 10px; }
    </style>
</head>
<body>
    <h1 id="homework-title">Homework 1 - Physics 217</h1>
    <div id="student-input">
        <label for="student-id">Enter your Student ID:</label>
        <input type="text" id="student-id">
        <button id="load-homework-button">Load Homework</button>
    </div>
    <div id="homework-problems"></div>
    <div id="submission">
        <button id="submit-answers-button" style="display: none;">Submit Answers</button>
    </div>
</body>
</html>
